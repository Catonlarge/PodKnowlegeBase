# EnglishPod-KnowledgeBase - 开发配置指南

| 文档版本 | V1.1 |
| --- | --- |
| **日期** | 2026-02-05 |
| **适用系统** | Windows 10/11 |

> 本文档提供从零开始搭建 EnglishPod3 Enhanced 开发环境的完整步骤，按顺序执行即可完成环境配置。

---

## 前置检查清单

在开始之前，请确认以下软件已安装：

| 软件 | 最低版本 | 检查命令 | 下载地址 |
| --- | --- | --- | --- |
| **Python** | 3.8+ | `python --version` | [python.org](https://www.python.org/downloads/) |
| **Git** | 2.x | `git --version` | [git-scm.com](https://git-scm.com/downloads/win) |
| **FFmpeg** | 5.x+ | `ffmpeg -version` | [gyan.dev](https://www.gyan.dev/ffmpeg/builds/) |

### FFmpeg 安装（Windows）

1. 下载 FFmpeg 完整版：`ffmpeg-release-essentials.zip`
2. 解压到 `C:\ffmpeg`
3. 添加到系统环境变量 PATH：`C:\ffmpeg\bin`
4. 验证安装：打开 PowerShell 执行 `ffmpeg -version`

---

## 第一步：创建项目目录结构

在 Windows PowerShell 或终端中执行：

```powershell
# 创建项目根目录
mkdir D:\programming_enviroment\EnglishPod-knowledgeBase
cd D:\programming_enviroment\EnglishPod-knowledgeBase

# 创建后端目录结构
mkdir backend
mkdir backend\app
mkdir backend\app\services
mkdir backend\app\utils
mkdir backend\app\models
mkdir backend\data
mkdir backend\data\audios
mkdir backend\data\transcript
mkdir backend\data\temp_segments
mkdir backend\logs
mkdir backend\tests

# 验证目录结构
Get-ChildItem -Recurse backend
```

预期目录结构：
```
backend/
├── app/
│   ├── services/
│   ├── utils/
│   └── models/
├── data/
│   ├── audios/
│   ├── transcript/
│   └── temp_segments/
├── logs/
└── tests/
```

---

## 第二步：创建 Python 虚拟环境

```powershell
# 进入后端目录
cd D:\programming_enviroment\EnglishPod-knowledgeBase\backend

# 创建虚拟环境（命名为 venv-kb 避免与其他项目冲突）
python -m venv venv-kb

# 激活虚拟环境
.\venv-kb\Scripts\Activate.ps1

# 验证 Python 路径（应指向虚拟环境）
where python
```

如果激活时遇到执行策略错误，先执行：
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

---

## 第三步：创建依赖配置文件

### 3.1 创建 requirements.txt

```powershell
# 在 backend 目录下创建 requirements.txt
@"
# ==================== Web 框架 ====================
fastapi>=0.100.0
uvicorn[standard]>=0.23.0
pydantic>=2.0.0

# ==================== 数据库 ====================
sqlalchemy>=2.0.0

# ==================== AI 能力 ====================
openai>=1.0.0
google-generativeai>=0.3.0
whisperx>=3.1.0
psutil>=5.9.0

# ==================== 音视频处理 ====================
yt-dlp>=2023.10.0
ffmpeg-python>=0.2.0

# ==================== CLI 与终端 UI ====================
rich>=13.7.0
typer>=0.9.0

# ==================== Markdown 处理 ====================
python-frontmatter>=1.0.0

# ==================== 平台集成 ====================
lark-oapi>=1.2.0

# ==================== 配置与日志 ====================
python-dotenv>=1.0.0
pyyaml>=6.0.0
loguru>=0.7.0

# ==================== 测试 ====================
pytest>=7.4.0
pytest-asyncio>=0.21.0

# ==================== 开发工具 ====================
black>=23.0.0
isort>=5.12.0
"@ | Out-File -FilePath requirements.txt -Encoding utf8
```

### 3.2 安装依赖

```powershell
# 确保虚拟环境已激活
.\venv-kb\Scripts\Activate.ps1

# 升级 pip
python -m pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt

# 验证关键依赖
python -c "import whisperx; print('WhisperX OK')"
python -c "import openai; print('OpenAI OK')"
python -c "import sqlalchemy; print('SQLAlchemy OK')"
python -c "import yaml; print('PyYAML OK')"
python -c "from rich import print; print('[green]Rich OK[/green]')"
```

---

## 第四步：创建配置文件

本系统采用**分级配置**：
- **API Keys**: 从 Windows 环境变量读取（不允许在 .env 中硬编码）
- **其他配置**: 从 config.yaml 文件读取

### 4.1 创建 config.yaml

```powershell
# 在 backend 目录下创建 config.yaml
@"
# ============================================
# Configuration File (Non-Sensitive Settings)
# ============================================
# API Keys are loaded from environment variables (ALL REQUIRED):
#   - GEMINI_API_KEY (for Google Gemini)
#   - MOONSHOT_API_KEY (for Moonshot Kimi)
#   - ZHIPU_API_KEY (for Zhipu AI/GLM)
#   - HF_TOKEN (for HuggingFace WhisperX diarization)
#
# Set them in Windows:
#   setx GEMINI_API_KEY 'your_key_here'
#   setx MOONSHOT_API_KEY 'your_key_here'
#   setx ZHIPU_API_KEY 'your_key_here'
#   setx HF_TOKEN 'your_token_here'
# ============================================

# Application Settings
app:
  name: 'EnglishPod-KnowledgeBase'
  version: '1.0.0'
  debug: true

# Database Settings
database:
  path: './data/episodes.db'
  echo: false

# Obsidian Integration
obsidian:
  vault_path: ''
  notes_subdir: 'Episodes'

# AI Service Configuration
ai:
  moonshot:
    base_url: 'https://api.moonshot.cn/v1'
    model: 'moonshot-v1-8k'
    timeout: 120
  zhipu:
    base_url: 'https://open.bigmodel.cn/api/paas/v4'
    model: 'glm-4-plus'
    timeout: 60
  gemini:
    model: 'gemini-2.5-flash'
    timeout: 60
  query_timeout: 60
  use_mock: false

# Audio Processing
audio:
  temp_dir: './data/temp'
  whisper_model: 'base'
  whisper_device: 'cuda'
  segment_duration: 180
  default_language: 'en-US'
  storage_path: './data/audios'
  max_file_size: 1073741824

# Logging
logging:
  level: 'INFO'
  file: './logs/app.log'
  rotation: '10 MB'
  retention: '7 days'

# API Server
api:
  host: '127.0.0.1'
  port: 8000
  cors_origins:
    - 'http://localhost:5173'
    - 'http://127.0.0.1:5173'
"@ | Out-File -FilePath config.yaml -Encoding utf8
```

### 4.2 设置 Windows 环境变量

```powershell
# 设置 API Keys（永久生效，需重启终端后生效）
setx GEMINI_API_KEY "your_gemini_key_here"
setx MOONSHOT_API_KEY "your_moonshot_key_here"
setx ZHIPU_API_KEY "your_zhipu_key_here"
setx HF_TOKEN "your_hf_token_here"

# 验证设置（重启终端后）
echo $env:GEMINI_API_KEY
echo $env:MOONSHOT_API_KEY
echo $env:ZHIPU_API_KEY
echo $env:HF_TOKEN
```

**注意**：
- `setx` 设置的环境变量在新的终端会话中生效
- 如需当前会话立即生效，可使用 `$env:VARIABLE_NAME="value"` （仅当前会话有效）
- **绝对禁止**将 API Keys 写入 .env 文件或提交到版本控制

### 4.3 创建 .env.example（仅供参考）

```powershell
# 创建 .env.example 作为配置模板（不含真实密钥）
@"
# ============================================
# Environment Variables Template
# ============================================
# This is a reference file. DO NOT put real API keys here.
# Set environment variables in Windows using setx command.

# Required Environment Variables:
# GEMINI_API_KEY=your_gemini_key_here
# MOONSHOT_API_KEY=your_moonshot_key_here
# ZHIPU_API_KEY=your_zhipu_key_here
# HF_TOKEN=your_huggingface_token_here
"@ | Out-File -FilePath .env.example -Encoding utf8
```

---

## 第五步：配置 Obsidian

Obsidian 是本项目的"皮肤层"，用于中英对照内容的可视化编辑和校对。

### 5.1 安装 Obsidian

1. 下载 Obsidian：https://obsidian.md/download
2. 安装并启动 Obsidian

### 5.2 Obsidian Vault 已在项目内创建

项目已包含预配置的 Obsidian vault：

```
D:\programming_enviroment\EnglishPod-knowledgeBase\obsidian\
├── .obsidian/       # Obsidian 配置
├── episodes/        # 生成的 Episode 文档
├── templates/       # 文档模板
└── assets/          # 附件资源
```

### 5.3 在 Obsidian 中打开 Vault

1. 启动 Obsidian
2. 点击 "打开文件夹作为仓库"
3. 选择 `D:\programming_enviroment\EnglishPod-knowledgeBase\obsidian`
4. 点击 "打开"

### 5.4 更新 config.yaml 中的 Obsidian 路径

```powershell
# 编辑 config.yaml，设置正确的 Obsidian vault 路径
# 将 obsidian.vault_path 设置为:
# "D:/programming_enviroment/EnglishPod-knowledgeBase/obsidian"
```

### 5.4 配置 Obsidian 设置

打开 Obsidian 后，按 `Ctrl + ,` 打开设置：

| 设置项 | 推荐值 | 说明 |
| --- | --- | --- |
| **编辑器** | | |
| - 行宽 | 800 | 适合阅读的宽度 |
| - 拼写检查 | 开启 | 帮助发现拼写错误 |
| **文件与链接** | | |
| - 附件文件夹 | `assets/` | 统一管理附件 |
| - 新建文件的存放位置 | `episodes/` | 新建文档默认位置 |
| **外观** | | |
| - 主题 | Default 或 Minimal | 保持简洁 |
| - 基础字体大小 | 16px | 舒适阅读 |

### 5.5 安装推荐插件（可选）

Obsidian 社区插件可增强编辑体验：

1. 打开设置 → 第三方插件 → 浏览
2. 搜索并安装以下插件：

| 插件名称 | 用途 | 必需 |
| --- | --- | --- |
| **Dataview** | 查询和管理元数据 | 推荐 |
| **Advanced Tables** | 表格编辑增强 | 推荐 |
| **Calendar** | 日历视图 | 可选 |

### 5.6 创建文档模板

创建 `templates/episode_template.md` 作为 Episode 文档模板：

```powershell
@"
---
episode_id: {{episode_id}}
title: {{title}}
show_name: {{show_name}}
source_url: {{source_url}}
duration: {{duration}}
workflow_status: ready_for_review
created_at: {{created_at}}
reviewed: false
---

# {{title}}

## AI Summary

{{ai_summary}}

## Table of Contents

{{toc}}

## Chapters

{% for chapter in chapters %}
### {{chapter.title}}

{{chapter.summary}}

{% endfor %}

## Transcript

| 时间轴 | 英文原文 | 中文翻译 | 状态 |
| :--- | :--- | :--- | :--- |
{% for cue in cues %}| [{{cue.start_time}}](cue://{{cue.id}}) | {{cue.text}} | {{cue.translation}} | {% if cue.is_edited %}[green]已校对[/green]{% else %}[yellow]待校对[/yellow]{% endif %} |
{% endfor %}

## Metadata

- **Episode ID**: {{episode_id}}
- **Show**: {{show_name}}
- **Duration**: {{duration}} seconds
- **Language**: {{language}}
- **Created**: {{created_at}}
- **Reviewed**: {% if reviewed %}[green]Yes[/green]{% else %}[red]No[/red]{% endif %}
"@ | Out-File -FilePath "D:\ObsidianVault\EnglishPod3\templates\episode_template.md" -Encoding utf8
```

### 5.7 Obsidian 工作流程

```
┌─────────────────────────────────────────────────────────────┐
│  1. run.py 生成 Markdown 文档 → episodes/ 目录             │
├─────────────────────────────────────────────────────────────┤
│  2. 在 Obsidian 中打开文档，校对翻译                        │
│     - 修改中文翻译                                           │
│     - 添加 AI 摘要                                           │
│     - 调整章节标题                                           │
│     - 标记 reviewed: true                                    │
├─────────────────────────────────────────────────────────────┤
│  3. publish.py 读取 Markdown 文档 → 回填数据库 → 分发平台  │
└─────────────────────────────────────────────────────────────┘
```

---

## 第六步：创建 .gitignore

```powershell
@"
# ==================== Python ====================
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/
ENV/

# ==================== 数据库 ====================
*.db
*.db-journal
*.db-shm
*.db-wal

# ==================== 日志 ====================
logs/
*.log

# ==================== AI 模型缓存 ====================
data/transcript/
data/temp_segments/

# ==================== 配置文件（敏感信息）====================
.env
.env.local

# ==================== IDE ====================
.vscode/
.idea/
*.swp
*.swo

# ==================== OS ====================
.DS_Store
Thumbs.db
"@ | Out-File -FilePath .gitignore -Encoding utf8
```

---

## 第七步：验证基础环境配置

```powershell
# 确保虚拟环境已激活
cd D:\programming_enviroment\EnglishPod-knowledgeBase\backend
.\venv-kb\Scripts\Activate.ps1

# 验证 Python 和依赖
python --version
pip list | Select-String -Pattern "whisperx|openai|sqlalchemy|rich|loguru|yaml"

# 验证配置文件
Test-Path config.yaml
Get-Content config.yaml | Select-String -Pattern "app:|ai:|obsidian:"

# 验证环境变量
echo $env:GEMINI_API_KEY
echo $env:MOONSHOT_API_KEY
echo $env:ZHIPU_API_KEY
echo $env:HF_TOKEN

# 验证 Obsidian 目录
Test-Path "D:\programming_enviroment\EnglishPod-knowledgeBase\obsidian"
```

预期输出：所有验证命令返回 `True` 或显示正确的版本信息。

---

## 第八步：创建 Python 包初始化文件

```powershell
# 确保 virtual environment 已激活
cd D:\programming_enviroment\EnglishPod-knowledgeBase\backend

# 创建 __init__.py 文件（Python 包必需）
@"
"""EnglishPod-KnowledgeBase Backend Application"""
__version__ = "0.1.0"
"@ | Out-File -FilePath app\__init__.py -Encoding utf8

@"
"""Services模块"""
"@ | Out-File -FilePath app\services\__init__.py -Encoding utf8

@"
"""Utils模块"""
"@ | Out-File -FilePath app\utils\__init__.py -Encoding utf8

@"
"""Models模块"""
"@ | Out-File -FilePath app\models\__init__.py -Encoding utf8

# 验证创建结果
Get-ChildItem app -Recurse -Filter "__init__.py"
```

---

## 第九步：从 PodFlow 复制代码模块

### 9.1 复制清单

| PodFlow 源文件 | 目标位置 | 说明 |
| --- | --- | --- |
| `backend/app/utils/hardware_patch.py` | `backend/app/utils/hardware_patch.py` | 完全复制 |
| `backend/app/services/whisper_service.py` | `backend/app/services/whisper_service.py` | 完全复制 |
| `backend/app/services/transcription_service.py` | `backend/app/services/transcription_service.py` | 完全复制 |
| `backend/app/services/ai_service.py` | `backend/app/services/ai_service.py` | 复制后扩展 |
| `backend/app/utils/file_utils.py` | `backend/app/utils/file_utils.py` | 完全复制 |
| `backend/app/config.py` | `backend/app/config.py` | 复制结构后调整 |

### 9.2 复制命令（PowerShell）

```powershell
# 定义源目录和目标目录
$podflowBackend = "D:\programming_enviroment\learning-EnglishPod3\backend"
$targetBackend = "D:\programming_enviroment\EnglishPod-knowledgeBase\backend"

# 复制文件
Copy-Item "$podflowBackend\app\utils\hardware_patch.py" -Destination "$targetBackend\app\utils\hardware_patch.py"
Copy-Item "$podflowBackend\app\services\whisper_service.py" -Destination "$targetBackend\app\services\whisper_service.py"
Copy-Item "$podflowBackend\app\services\transcription_service.py" -Destination "$targetBackend\app\services\transcription_service.py"
Copy-Item "$podflowBackend\app\services\ai_service.py" -Destination "$targetBackend\app\services\ai_service.py"
Copy-Item "$podflowBackend\app\utils\file_utils.py" -Destination "$targetBackend\app\utils\file_utils.py"
Copy-Item "$podflowBackend\app\config.py" -Destination "$targetBackend\app\config.py"

# 验证复制结果
Get-ChildItem $targetBackend\app -Recurse -Filter "*.py"
```

---

## 第十步：创建数据库模型

### 10.1 创建 models.py

```powershell
# 确保在 backend 目录
cd D:\programming_enviroment\EnglishPod-knowledgeBase\backend

# 创建数据库模型文件
@"
from sqlalchemy import create_engine, Column, Integer, String, Text, DateTime, Float, ForeignKey, Boolean, UniqueConstraint, Index
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, relationship
from datetime import datetime

Base = declarative_base()

# ==================== 工作流状态枚举 ====================
class WorkflowStatus:
    INIT = 0                # 已入库，URL已记录
    DOWNLOADED = 1          # 本地文件就绪
    TRANSCRIBED = 2         # WhisperX转录完成
    SEGMENTED = 3           # 语义章节切分完成
    TRANSLATED = 4          # 逐句翻译完成
    READY_FOR_REVIEW = 5    # Obsidian文档已生成
    PUBLISHED = 6           # 已分发

# ==================== Episode 表 ====================
class Episode(Base):
    __tablename__ = "episodes"

    id = Column(Integer, primary_key=True, index=True)
    title = Column(String(255), nullable=False)
    show_name = Column(String(255), nullable=True)
    source_url = Column(String(500), nullable=True)
    audio_path = Column(String(500), nullable=True)
    file_hash = Column(String(64), nullable=False, unique=True, index=True)
    file_size = Column(Integer, nullable=True)
    duration = Column(Float, nullable=False)
    language = Column(String(10), nullable=False, default="en-US")
    ai_summary = Column(Text, nullable=True)
    workflow_status = Column(Integer, nullable=False, default=0, index=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)

    # 关系映射
    segments = relationship("AudioSegment", back_populates="episode", cascade="all, delete-orphan")
    transcript_cues = relationship("TranscriptCue", back_populates="episode", cascade="all, delete-orphan")
    chapters = relationship("Chapter", back_populates="episode", cascade="all, delete-orphan")
    publication_records = relationship("PublicationRecord", back_populates="episode", cascade="all, delete-orphan")
    marketing_posts = relationship("MarketingPost", back_populates="episode", cascade="all, delete-orphan")

# ==================== AudioSegment 表 ====================
class AudioSegment(Base):
    __tablename__ = "audio_segments"

    id = Column(Integer, primary_key=True, index=True)
    episode_id = Column(Integer, ForeignKey("episodes.id", ondelete="CASCADE"), nullable=False)
    segment_index = Column(Integer, nullable=False)
    segment_id = Column(String(50), nullable=False)
    segment_path = Column(String(500), nullable=True)
    start_time = Column(Float, nullable=False)
    end_time = Column(Float, nullable=False)
    status = Column(String(20), nullable=False, default="pending")
    error_message = Column(Text, nullable=True)
    retry_count = Column(Integer, nullable=False, default=0)
    transcription_started_at = Column(DateTime, nullable=True)
    recognized_at = Column(DateTime, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # 关系映射
    episode = relationship("Episode", back_populates="segments")
    transcript_cues = relationship("TranscriptCue", back_populates="segment", cascade="all, delete-orphan")

    __table_args__ = (
        UniqueConstraint('episode_id', 'segment_index', name='_episode_segment_uc'),
        Index('idx_episode_segment', 'episode_id', 'segment_index'),
        Index('idx_segment_status', 'status'),
    )

# ==================== TranscriptCue 表 ====================
class TranscriptCue(Base):
    __tablename__ = "transcript_cues"

    id = Column(Integer, primary_key=True, index=True)
    episode_id = Column(Integer, ForeignKey("episodes.id", ondelete="CASCADE"), nullable=False)
    segment_id = Column(Integer, ForeignKey("audio_segments.id", ondelete="CASCADE"), nullable=True)
    start_time = Column(Float, nullable=False)
    end_time = Column(Float, nullable=False)
    speaker = Column(String(50), nullable=False, default="Unknown")
    text = Column(Text, nullable=False)
    chapter_id = Column(Integer, ForeignKey("chapters.id", ondelete="SET NULL"), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # 关系映射
    episode = relationship("Episode", back_populates="transcript_cues")
    segment = relationship("AudioSegment", back_populates="transcript_cues")
    translations = relationship("Translation", back_populates="cue", cascade="all, delete-orphan")

# ==================== Chapter 表 ====================
class Chapter(Base):
    __tablename__ = "chapters"

    id = Column(Integer, primary_key=True, index=True)
    episode_id = Column(Integer, ForeignKey("episodes.id", ondelete="CASCADE"), nullable=False)
    chapter_index = Column(Integer, nullable=False)
    title = Column(String(255), nullable=False)
    summary = Column(Text, nullable=True)
    start_time = Column(Float, nullable=False)
    end_time = Column(Float, nullable=False)
    status = Column(String(20), nullable=False, default="pending")
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

    # 关系映射
    episode = relationship("Episode", back_populates="chapters")

# ==================== Translation 表 ====================
class Translation(Base):
    __tablename__ = "translations"

    id = Column(Integer, primary_key=True, index=True)
    cue_id = Column(Integer, ForeignKey("transcript_cues.id", ondelete="CASCADE"), nullable=False)
    language_code = Column(String(10), nullable=False)
    original_translation = Column(Text, nullable=True)
    translation = Column(Text, nullable=True)
    is_edited = Column(Boolean, nullable=False, default=False)
    translation_status = Column(String(20), nullable=False, default="pending")
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

# ==================== PublicationRecord 表 ====================
class PublicationRecord(Base):
    __tablename__ = "publication_records"

    id = Column(Integer, primary_key=True, index=True)
    episode_id = Column(Integer, ForeignKey("episodes.id", ondelete="CASCADE"), nullable=False)
    platform = Column(String(50), nullable=False)
    status = Column(String(20), nullable=False, default="pending")
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

# ==================== MarketingPost 表 ====================
class MarketingPost(Base):
    __tablename__ = "marketing_posts"

    id = Column(Integer, primary_key=True, index=True)
    episode_id = Column(Integer, ForeignKey("episodes.id", ondelete="CASCADE"), nullable=False)
    chapter_id = Column(Integer, ForeignKey("chapters.id", ondelete="SET NULL"), nullable=True)
    platform = Column(String(50), nullable=False)
    angle_tag = Column(String(50), nullable=False)
    title = Column(String(255), nullable=False)
    content = Column(Text, nullable=False)
    status = Column(String(20), nullable=False, default="pending")
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)

# ==================== 数据库配置 ====================
DATABASE_URL = "sqlite:///./data/episodes.db"

engine = create_engine(
    DATABASE_URL,
    connect_args={"check_same_thread": False}
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def init_db():
    Base.metadata.create_all(bind=engine)
"@ | Out-File -FilePath app\models.py -Encoding utf8
```

### 10.2 初始化数据库

```powershell
# 确保虚拟环境已激活
cd D:\programming_enviroment\EnglishPod-knowledgeBase\backend
.\venv-kb\Scripts\Activate.ps1

# 创建数据库初始化脚本
@"
from app.models import init_db
if __name__ == "__main__":
    init_db()
    print("Database initialized successfully!")
"@ | Out-File -FilePath init_db.py -Encoding utf8

# 运行初始化
python init_db.py

# 验证数据库文件已创建
Get-ChildItem data\episodes.db
```

---

## 第十一步：创建第一个 CLI 命令（run.py）

```powershell
@"
import typer
from rich.console import Console
from rich.panel import Panel

app = typer.Typer()
console = Console()

@app.command()
def main(url: str = typer.Argument(..., help="视频/音频 URL")):
    \"\"\"生产阶段：下载并处理视频\"\"\"
    console.print(Panel.fit(
        f"[bold blue]EnglishPod3 Enhanced[/bold blue]\n\n"
        f"处理 URL: {url}\n\n"
        f"状态: [yellow]初始化中...[/yellow]",
        title="任务控制台"
    ))
    console.print("\n[green]✓[/green] 环境检查完成")
    console.print("[yellow]→[/yellow] 下载阶段")
    console.print("[yellow]→[/yellow] 转录阶段")
    console.print("[yellow]→[/yellow] 切分阶段")
    console.print("[yellow]→[/yellow] 翻译阶段")
    console.print("[yellow]→[/yellow] 生成 Obsidian 文档")

if __name__ == "__main__":
    app()
"@ | Out-File -FilePath run.py -Encoding utf8

# 测试运行
python run.py --help
```

---

## 第十二步：最终验证

```powershell
# 确保 virtual environment 已激活
cd D:\programming_enviroment\EnglishPod-knowledgeBase\backend
.\venv-kb\Scripts\Activate.ps1

# 运行最终验证
@"
print('=' * 50)
print('EnglishPod-KnowledgeBase - 最终环境验证')
print('=' * 50)

# 测试导入
try:
    from app.models import Base, engine
    print('[OK] SQLAlchemy models')
except Exception as e:
    print(f'[FAIL] SQLAlchemy models: {e}')

try:
    from app.services.whisper_service import WhisperService
    print('[OK] WhisperService')
except Exception as e:
    print(f'[FAIL] WhisperService: {e}')

try:
    from app.services.ai_service import AIService
    print('[OK] AIService')
except Exception as e:
    print(f'[FAIL] AIService: {e}')

try:
    from rich.console import Console
    console = Console()
    console.print('[green][OK] Rich[/green]')
except Exception as e:
    print(f'[FAIL] Rich: {e}')

try:
    from loguru import logger
    print('[OK] Loguru')
except Exception as e:
    print(f'[FAIL] Loguru: {e}')

# 测试配置
try:
    from app.config import MOONSHOT_MODEL, ZHIPU_MODEL, GEMINI_MODEL
    print(f'[OK] Config - Moonshot: {MOONSHOT_MODEL}')
    print(f'[OK] Config - Zhipu: {ZHIPU_MODEL}')
    print(f'[OK] Config - Gemini: {GEMINI_MODEL}')
except Exception as e:
    print(f'[FAIL] Config: {e}')

# 测试数据库
try:
    import os
    print(f'[OK] Database: {os.path.exists("data/episodes.db")}')
except Exception as e:
    print(f'[FAIL] Database: {e}')

print('=' * 50)
print('环境配置完成！')
"@ | Out-File -FilePath verify_final.py -Encoding utf8

python verify_final.py
```

预期输出：
```
==================================================
EnglishPod-KnowledgeBase - 最终环境验证
==================================================
[OK] SQLAlchemy models
[OK] WhisperService
[OK] AIService
[OK] Rich
[OK] Loguru
[OK] Config - Moonshot: moonshot-v1-8k
[OK] Config - Zhipu: glm-4-plus
[OK] Config - Gemini: gemini-2.5-flash
[OK] Database: True
==================================================
环境配置完成！
```

---

## 快速参考

### 常用命令

```powershell
# 激活虚拟环境
cd D:\programming_enviroment\EnglishPod-knowledgeBase\backend
.\venv-kb\Scripts\Activate.ps1

# 安装新依赖
pip install package_name

# 重新生成 requirements.txt
pip freeze > requirements.txt

# 重置数据库（开发阶段）
Remove-Item data\episodes.db
python init_db.py

# 查看日志
Get-Content logs\app_*.log | Select-Object -Last 50
```

### 环境变量参考（必需）

| 变量名 | 说明 | 获取地址 |
| --- | --- | --- |
| `GEMINI_API_KEY` | Google Gemini API 密钥 | [Google AI Studio](https://makersuite.google.com/app/apikey) |
| `MOONSHOT_API_KEY` | Moonshot Kimi API 密钥 | [Moonshot](https://platform.moonshot.cn/) |
| `ZHIPU_API_KEY` | 智谱 GLM API 密钥 | [Zhipu AI](https://open.bigmodel.cn/) |
| `HF_TOKEN` | HuggingFace Token | [HF Settings](https://huggingface.co/settings/tokens) |

**设置方法**：
```powershell
setx GEMINI_API_KEY "your_key_here"
setx MOONSHOT_API_KEY "your_key_here"
setx ZHIPU_API_KEY "your_key_here"
setx HF_TOKEN "your_token_here"
```

### 配置文件参考

config.yaml 中的关键配置：

| 配置项 | 默认值 | 说明 |
| --- | --- | --- |
| `ai.moonshot.model` | `moonshot-v1-8k` | 主要 AI 模型 |
| `ai.zhipu.model` | `glm-4-plus` | 备用 AI 模型 |
| `ai.gemini.model` | `gemini-2.5-flash` | Gemini 模型 |
| `audio.whisper_device` | `cuda` | Whisper 设备 |
| `audio.whisper_model` | `base` | Whisper 模型 |

### 目录结构速查

```
D:\programming_enviroment\EnglishPod-knowledgeBase\
├── backend/
│   ├── app/
│   │   ├── services/       # 业务逻辑层
│   │   ├── utils/          # 工具函数
│   │   ├── models/         # 数据库模型
│   │   └── config.py       # 配置加载
│   ├── data/               # 数据目录
│   │   ├── audios/         # 音频文件
│   │   └── temp/           # 临时文件
│   ├── logs/               # 日志文件
│   ├── tests/              # 测试文件
│   ├── venv-kb/            # 虚拟环境
│   ├── config.yaml         # 配置文件（非敏感）
│   ├── requirements.txt    # 依赖列表
│   └── .env.example        # 环境变量模板
├── obsidian/               # Obsidian Vault（在项目内）
│   ├── episodes/           # 生成的 Markdown 文档
│   ├── templates/          # 文档模板
│   ├── assets/             # 附件资源
│   └── .obsidian/          # Obsidian 配置
└── docs/                   # 项目文档
```

---

## 故障排查

### 问题 1：WhisperX 导入失败

```
Error: ModuleNotFoundError: No module named 'whisperx'
```

**解决方案**：
```powershell
# 确保虚拟环境已激活
.\venv-kb\Scripts\Activate.ps1

# 重新安装 WhisperX
pip install --upgrade whisperx
```

### 问题 2：CUDA 不可用

```
Error: CUDA not available
```

**解决方案**：
```powershell
# 检查 CUDA 安装
nvidia-smi

# 如果没有 CUDA，修改 config.yaml
# audio.whisper_device: cpu
```

### 问题 3：FFmpeg 未找到

```
Error: FFmpeg 未安装或不在 PATH 中
```

**解决方案**：
```powershell
# 检查 FFmpeg
ffmpeg -version

# 如果提示命令不存在，添加到 PATH
# 系统属性 -> 环境变量 -> Path -> 新建 -> C:\ffmpeg\bin
```

### 问题 4：模块导入失败

```
ModuleNotFoundError: No module named 'app'
```

**解决方案**：
```powershell
# 确保 __init__.py 文件已创建
Get-ChildItem app -Recurse -Filter "__init__.py"

# 如果缺失，手动创建
cd D:\programming_enviroment\EnglishPod-knowledgeBase\backend
# 然后执行第八步的命令
```

---

## 下一步

环境配置完成后，参考以下文档继续开发：

1. [数据库设计文档](./database-design.md) - 了解数据库表结构
2. [产品需求文档](./prd.md) - 了解功能需求
3. [技术栈文档](./技术栈.md) - 了解技术选型
4. [开发计划](./开发计划.md) - 了解开发路线图

---

**文档结束** | 配置问题请查阅故障排查章节

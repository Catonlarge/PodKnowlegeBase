# 项目目录结构设计：EnglishPod3 Enhanced

| 文档版本 | V1.0 |
| --- | --- |
| **日期** | 2026-02-05 |
| **状态** | 待审核 |
| **架构原则** | **后端数据库做骨架 + Obsidian 做皮肤 + CLI 做扳机** |

---

## 目录

1. [总体结构](#1-总体结构)
2. [目录树](#2-目录树)
3. [模块职责说明](#3-模块职责说明)
4. [与 PodFlow 的复用关系](#4-与-podflow-的复用关系)
5. [工作流代码映射](#5-工作流代码映射)

---

## 1. 总体结构

### 1.1 架构分层

```
┌─────────────────────────────────────────────────────────────┐
│                      用户交互层                               │
├─────────────────────────────────────────────────────────────┤
│  CLI (run.py, publish.py)  │  Obsidian (Markdown 文档)      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (app/)                           │
├─────────────────────────────────────────────────────────────┤
│  api/ (HTTP)  │  services/ (业务逻辑)  │  models/ (数据)    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层                                  │
├─────────────────────────────────────────────────────────────┤
│  SQLite Database  │  Obsidian Vault  │  Audio Files         │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 设计原则

| 原则 | 实现方式 |
| --- | --- |
| **关注点分离** | api/ 处理 HTTP，services/ 处理业务逻辑，models/ 处理数据 |
| **高内聚低耦合** | 相关模块内聚，模块间低耦合（如 download_service 只负责下载） |
| **可测试性** | tests/ 与 app/ 平行结构，便于单元测试 |
| **可复用性** | 从 PodFlow 复用核心服务（whisper_service, transcription_service） |
| **扩展性** | services/ 可独立扩展新的发布平台（publishers/） |

---

## 2. 目录树

```
EnglishPod-knowledgeBase/
│
├── backend/                           # Python 后端
│   ├── app/                           # 应用核心代码
│   │   ├── __init__.py                # 包初始化
│   │   ├── main.py                    # FastAPI 主入口
│   │   ├── config.py                  # 配置管理 [从 PodFlow 复用]
│   │   ├── database.py                # 数据库连接管理
│   │   ├── dependencies.py            # FastAPI 依赖注入
│   │   │
│   │   ├── api/                       # API 路由层 (HTTP 接口)
│   │   │   ├── __init__.py
│   │   │   ├── episodes.py            # Episode CRUD 接口
│   │   │   ├── transcripts.py         # Transcript 查询接口
│   │   │   ├── translations.py        # Translation 修正接口
│   │   │   ├── chapters.py            # Chapter 查询接口
│   │   │   ├── marketing.py           # 营销文案接口
│   │   │   └── publications.py        # 发布状态查询接口
│   │   │
│   │   ├── models/                    # SQLAlchemy 模型 (数据库表)
│   │   │   ├── __init__.py
│   │   │   ├── base.py                # Base 声明
│   │   │   ├── episode.py             # Episode 模型
│   │   │   ├── audio_segment.py       # AudioSegment 模型 [从 PodFlow 复用结构]
│   │   │   ├── transcript_cue.py      # TranscriptCue 模型 [从 PodFlow 复用结构]
│   │   │   ├── translation.py         # Translation 模型 (RLHF 双文本)
│   │   │   ├── chapter.py             # Chapter 模型
│   │   │   ├── marketing_post.py      # MarketingPost 模型
│   │   │   └── publication_record.py  # PublicationRecord 模型
│   │   │
│   │   ├── schemas/                   # Pydantic 模型 (请求/响应)
│   │   │   ├── __init__.py
│   │   │   ├── episode.py             # Episode 请求/响应模型
│   │   │   ├── transcript.py          # Transcript 响应模型
│   │   │   ├── translation.py         # Translation 请求模型
│   │   │   └── chapter.py             # Chapter 响应模型
│   │   │
│   │   ├── services/                  # 业务逻辑层
│   │   │   ├── __init__.py
│   │   │   │
│   │   │   ├── download_service.py    # 音频下载服务 (yt-dlp)
│   │   │   ├── transcription_service.py # 转录服务 [从 PodFlow 复用]
│   │   │   ├── segmentation_service.py # 语义章节切分服务 (LLM)
│   │   │   ├── translation_service.py  # 翻译服务 (LLM)
│   │   │   ├── obsidian_service.py    # Obsidian 文档生成服务
│   │   │   ├── marketing_service.py   # 营销文案生成服务
│   │   │   │
│   │   │   ├── whisper/               # Whisper 相关 [从 PodFlow 复用]
│   │   │   │   ├── __init__.py
│   │   │   │   └── whisper_service.py # WhisperX 封装
│   │   │   │
│   │   │   ├── ai/                    # AI 服务 [从 PodFlow 复用结构]
│   │   │   │   ├── __init__.py
│   │   │   │   └── ai_service.py      # LLM 统一接口
│   │   │   │
│   │   │   └── publishers/            # 发布平台适配器
│   │   │       ├── __init__.py
│   │   │       ├── base.py            # 发布器基类
│   │   │       ├── feishu.py          # 飞书发布器
│   │   │       ├── ima.py             # 腾讯 IMA 发布器
│   │   │       └── marketing.py       # 营销端发布器
│   │   │
│   │   ├── utils/                     # 工具函数
│   │   │   ├── __init__.py
│   │   │   ├── file_utils.py          # 文件处理工具 [从 PodFlow 复用]
│   │   │   ├── time_utils.py          # 时间格式化工具
│   │   │   ├── markdown_utils.py      # Markdown 生成/解析工具
│   │   │   ├── hardware_patch.py      # 硬件加速补丁 [从 PodFlow 复用]
│   │   │   └── progress.py            # Rich 进度条工具
│   │   │
│   │   └── workflows/                 # 工作流编排 (CLI 入口)
│   │       ├── __init__.py
│   │       ├── runner.py              # 主工作流 (run.py)
│   │       ├── publisher.py           # 发布工作流 (publish.py)
│   │       └── state_machine.py       # 状态机管理
│   │
│   ├── tests/                         # 测试目录
│   │   ├── __init__.py
│   │   ├── conftest.py                # pytest 配置
│   │   │
│   │   ├── unit/                      # 单元测试
│   │   │   ├── test_download_service.py
│   │   │   ├── test_transcription_service.py
│   │   │   ├── test_translation_service.py
│   │   │   ├── test_segmentation_service.py
│   │   │   └── test_obsidian_service.py
│   │   │
│   │   ├── integration/               # 集成测试
│   │   │   ├── test_workflow_end_to_end.py
│   │   │   └── test_obsidian_integration.py
│   │   │
│   │   └── fixtures/                  # 测试数据
│   │       ├── audio_samples/
│   │       └── markdown_samples/
│   │
│   ├── data/                          # 数据目录
│   │   ├── database.db                # SQLite 数据库文件
│   │   ├── audio/                     # 音频文件存储
│   │   │   ├── downloads/             # 下载的原始音频
│   │   │   └── segments/              # 转录临时片段 (自动清理)
│   │   └── exports/                   # 导出数据
│   │
│   ├── scripts/                       # 脚本入口
│   │   ├── run.py                     # 主工作流入口 (CLI)
│   │   ├── publish.py                 # 发布工作流入口 (CLI)
│   │   └── init_db.py                 # 数据库初始化脚本
│   │
│   ├── requirements.txt               # Python 依赖
│   ├── .env.example                   # 环境变量示例
│   ├── .env                           # 环境变量 (不提交到 Git)
│   ├── .gitignore                     # Git 忽略文件
│   └── README.md                      # 后端说明文档
│
├── obsidian/                          # Obsidian Vault (皮肤层)
│   ├── .obsidian/                     # Obsidian 配置
│   │   ├── plugins/                   # 插件目录
│   │   ├── themes/                    # 主题目录
│   │   └── config.json                # Obsidian 配置文件
│   │
│   ├── templates/                     # Markdown 模板
│   │   ├── episode_template.md        # Episode 文档模板
│   │   └── chapter_template.md        # Chapter 文档模板
│   │
│   ├── episodes/                      # Episode 文档 (自动生成)
│   │   └── {episode_id}_{title}.md    # 格式: 1024_Business_English.md
│   │
│   └── assets/                        # 静态资源
│       ├── css/                       # 自定义样式
│       └── images/                    # 图片资源
│
├── docs/                              # 项目文档
│   ├── prd.md                         # 产品需求文档
│   ├── database-design.md             # 数据库设计文档
│   ├── 技术栈.md                       # 技术栈说明
│   ├── 开发配置.md                     # 开发环境配置
│   ├── 项目目录设计.md                 # 本文档
│   └── 开发计划.md                     # 开发计划
│
└── README.md                          # 项目根 README
```

---

## 3. 模块职责说明

### 3.1 CLI 入口层 (scripts/)

| 文件 | 职责 | 触发命令 |
| --- | --- | --- |
| `run.py` | 主工作流入口：下载 → 转录 → 切分 → 翻译 → 生成文档 | `python scripts/run.py <URL>` |
| `publish.py` | 发布工作流入口：解析 Obsidian 文档 → 回填数据库 → 分发 | `python scripts/publish.py --id <episode_id>` |
| `init_db.py` | 数据库初始化：创建表结构 | `python scripts/init_db.py` |

### 3.2 API 层 (app/api/)

| 文件 | 职责 | 主要端点 |
| --- | --- | --- |
| `episodes.py` | Episode CRUD | `POST /episodes`, `GET /episodes`, `GET /episodes/{id}` |
| `transcripts.py` | Transcript 查询 | `GET /episodes/{id}/transcripts` |
| `translations.py` | Translation 修正 | `PATCH /translations/{id}`, `POST /translations/batch-translate` |
| `chapters.py` | Chapter 查询 | `GET /episodes/{id}/chapters` |
| `marketing.py` | 营销文案 | `GET /episodes/{id}/marketing-posts`, `POST /marketing-posts/generate` |
| `publications.py` | 发布状态 | `POST /episodes/{id}/publish`, `GET /episodes/{id}/publication-status` |

### 3.3 服务层 (app/services/)

#### 核心服务

| 服务 | 职责 | 输入 | 输出 |
| --- | --- | --- | --- |
| `DownloadService` | 音频下载 (yt-dlp) | URL | 本地音频路径 |
| `TranscriptionService` | Whisper 转录 | 音频路径 | TranscriptCue 列表 |
| `SegmentationService` | AI 语义章节切分 | TranscriptCue 列表 | Chapter 列表 |
| `TranslationService` | LLM 翻译 | TranscriptCue 列表 | Translation 列表 |
| `ObsidianService` | Obsidian 文档生成 | Episode + 关联数据 | Markdown 文件 |
| `MarketingService` | 营销文案生成 | Episode/Chapter | MarketingPost 列表 |

#### 发布器 (app/services/publishers/)

| 发布器 | 职责 | 平台 |
| --- | --- | --- |
| `FeishuPublisher` | 发布到飞书多维表格/云文档 | 飞书 |
| `ImaPublisher` | 发布到腾讯 IMA 知识库 | 腾讯 IMA |
| `MarketingPublisher` | 同步到营销端数据库 | 营销端 |

### 3.4 工作流层 (app/workflows/)

| 模块 | 职责 | 状态管理 |
| --- | --- | --- |
| `runner.py` | 主工作流编排 | Episode.workflow_status (0→5) |
| `publisher.py` | 发布工作流编排 | Episode.workflow_status (5→6) |
| `state_machine.py` | 状态机逻辑 | 状态转移 + 断点续传 |

### 3.5 数据层 (app/models/)

| 模型 | 表名 | 核心字段 |
| --- | --- | --- |
| `Episode` | episodes | workflow_status (0-6) |
| `AudioSegment` | audio_segments | status (pending/processing/completed/failed) |
| `TranscriptCue` | transcript_cues | text, start_time, end_time |
| `Translation` | translations | original_translation, translation, is_edited |
| `Chapter` | chapters | title, summary (中文), start_time, end_time |
| `MarketingPost` | marketing_posts | platform, angle_tag, title, content |
| `PublicationRecord` | publication_records | platform, status |

### 3.6 工具层 (app/utils/)

| 模块 | 职责 | 来源 |
| --- | --- | --- |
| `file_utils.py` | 文件处理 (MD5、音频时长、格式验证) | [从 PodFlow 复用] |
| `time_utils.py` | 时间格式化 (秒 → MM:SS) | 新增 |
| `markdown_utils.py` | Markdown 生成/解析 (含 cue://ID 锚点) | 新增 |
| `hardware_patch.py` | Whisper 硬件加速补丁 | [从 PodFlow 复用] |
| `progress.py` | Rich 终端进度条 | 新增 |

---

## 4. 与 PodFlow 的复用关系

### 4.1 完全复用的模块

| PodFlow 文件 | 目标路径 | 复用程度 |
| --- | --- | --- |
| `backend/app/config.py` | `backend/app/config.py` | 100% (需扩展配置项) |
| `backend/app/utils/file_utils.py` | `backend/app/utils/file_utils.py` | 100% |
| `backend/app/utils/hardware_patch.py` | `backend/app/utils/hardware_patch.py` | 100% |
| `backend/app/services/whisper_service.py` | `backend/app/services/whisper/whisper_service.py` | 100% |
| `backend/app/services/transcription_service.py` | `backend/app/services/transcription_service.py` | 90% (需适配新状态机) |
| `backend/app/services/ai_service.py` | `backend/app/services/ai/ai_service.py` | 100% |

### 4.2 需要适配的模块

| PodFlow 模块 | 适配要点 |
| --- | --- |
| `AudioSegment` | 保持结构不变，集成到新的 Episode 工作流 |
| `TranscriptCue` | 增加 chapter_id 外键，增加 obsidian_anchor 属性 |
| `TranscriptionService` | 状态同步改为更新 Episode.workflow_status |

### 4.3 新增模块

| 模块 | 说明 |
| --- | --- |
| `SegmentationService` | AI 语义章节切分 (PodFlow 无此功能) |
| `TranslationService` | LLM 翻译服务 (PodFlow 无此功能) |
| `ObsidianService` | Obsidian 文档生成/解析 (PodFlow 无此功能) |
| `MarketingService` | 营销文案生成 (PodFlow 无此功能) |
| `publishers/` | 多平台发布适配器 (PodFlow 无此功能) |

---

## 5. 工作流代码映射

### 5.1 主工作流 (run.py)

```
┌────────────────────────────────────────────────────────────────┐
│                        run.py 工作流                            │
├────────────────────────────────────────────────────────────────┤
│  输入: URL (如 https://youtube.com/watch?v=xyz)                 │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. INIT (0)                                                    │
│     └── EpisodeRepository.create_from_url(url)                  │
│         └── 写入 episodes 表 (workflow_status=0)                │
│                                                                 │
│  2. DOWNLOADED (1)                                              │
│     └── DownloadService.download(url)                           │
│         ├── yt-dlp 下载音频                                     │
│         ├── file_utils.calculate_md5_async()                   │
│         └── 更新 workflow_status=1                              │
│                                                                 │
│  3. TRANSCRIBED (2)                                             │
│     └── TranscriptionService.segment_and_transcribe()          │
│         ├── 创建虚拟分段 (AudioSegment)                         │
│         ├── WhisperService.transcribe_segment() [PodFlow]      │
│         ├── 保存 TranscriptCue                                  │
│         └── 更新 workflow_status=2                              │
│                                                                 │
│  4. SEGMENTED (3)                                               │
│     └── SegmentationService.analyze_and_segment()              │
│         ├── 调用 AI (AIService.query) [PodFlow]                │
│         ├── 解析 JSON 章节划分                                  │
│         ├── 保存 Chapter                                       │
│         ├── 更新 TranscriptCue.chapter_id                      │
│         └── 更新 workflow_status=3                              │
│                                                                 │
│  5. TRANSLATED (4)                                              │
│     └── TranslationService.batch_translate()                   │
│         ├── 遍历 TranscriptCue                                  │
│         ├── 调用 AI (AIService.query) [PodFlow]                │
│         ├── 保存 Translation (RLHF 双文本)                     │
│         └── 更新 workflow_status=4                              │
│                                                                 │
│  6. READY_FOR_REVIEW (5)                                        │
│     └── ObsidianService.render_episode()                       │
│         ├── 生成 Markdown 文档 (含 cue://ID 锚点)              │
│         ├── 写入 obsidian/episodes/                            │
│         └── 更新 workflow_status=5                              │
│                                                                 │
│  输出: Obsidian 文档路径 (用户手动校对后调用 publish.py)        │
└────────────────────────────────────────────────────────────────┘
```

### 5.2 发布工作流 (publish.py)

```
┌────────────────────────────────────────────────────────────────┐
│                      publish.py 工作流                          │
├────────────────────────────────────────────────────────────────┤
│  输入: --id <episode_id> (如 --id 1024)                         │
├────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 解析 Obsidian 文档                                          │
│     └── ObsidianService.parse_episode()                        │
│         ├── 读取 Markdown 文件                                 │
│         ├── 提取 cue://ID 锚点                                 │
│         ├── 解析表格获取用户修改的翻译                          │
│         └── 返回 diff 列表                                     │
│                                                                 │
│  2. 回填数据库 (RLHF 双文本更新)                                │
│     └── TranslationRepository.batch_update()                   │
│         ├── 比较 original_translation vs 用户修改              │
│         ├── 更新 translation 字段                              │
│         ├── 设置 is_edited=TRUE (如有差异)                     │
│         └── 保存 TranslationCorrection 记录                    │
│                                                                 │
│  3. 生成营销文案 (可选)                                         │
│     └── MarketingService.generate_posts()                      │
│         ├── 调用 AI 生成多角度文案                             │
│         ├── 保存 MarketingPost (1:N 堆叠)                     │
│         └── 支持全篇/章节粒度                                  │
│                                                                 │
│  4. 分发到各平台                                                │
│     └── PublicationService.publish_to_platforms()             │
│         ├── FeishuPublisher.publish()                          │
│         ├── ImaPublisher.publish()                             │
│         ├── MarketingPublisher.publish()                       │
│         └── 保存 PublicationRecord                             │
│                                                                 │
│  5. 更新状态                                                    │
│     └── episode.workflow_status = 6 (PUBLISHED)                │
│                                                                 │
│  输出: 发布结果摘要                                             │
└────────────────────────────────────────────────────────────────┘
```

### 5.3 状态机转移逻辑

```python
# app/workflows/state_machine.py

class WorkflowStatus(IntEnum):
    INIT = 0                # 已入库，URL已记录
    DOWNLOADED = 1          # 本地文件就绪
    TRANSCRIBED = 2         # WhisperX转录完成
    SEGMENTED = 3           # 语义章节切分完成
    TRANSLATED = 4          # 逐句翻译完成
    READY_FOR_REVIEW = 5    # Obsidian文档已生成
    PUBLISHED = 6           # 已分发

def get_next_step(status: WorkflowStatus) -> Callable:
    """根据当前状态返回下一步的处理函数"""
    steps = {
        WorkflowStatus.INIT: create_episode,
        WorkflowStatus.DOWNLOADED: transcribe_episode,
        WorkflowStatus.TRANSCRIBED: segment_episode,
        WorkflowStatus.SEGMENTED: translate_episode,
        WorkflowStatus.TRANSLATED: render_obsidian_doc,
        WorkflowStatus.READY_FOR_REVIEW: publish_episode,
    }
    return steps.get(status)
```

---

## 6. 关键设计决策

### 6.1 为什么 workflows/ 独立于 scripts/？

| 设计 | 原因 |
| --- | --- |
| `scripts/` 只包含 CLI 入口 | 保持简洁，用户直接交互的命令 |
| `app/workflows/` 包含业务编排 | 可被 API 复用（如 POST /episodes/{id}/run） |
| 分离便于测试 | workflows/ 可独立单元测试 |

### 6.2 为什么 publishers/ 是独立目录？

| 设计 | 原因 |
| --- | --- |
| 每个平台一个文件 | 便于扩展新平台 (新增 twitter.py) |
| 继承 BasePublisher | 确保接口一致性 (publish() 方法) |
| 独立异常处理 | 某个平台失败不影响其他平台 |

### 6.3 为什么 obsidian/ 在项目根目录？

| 设计 | 原因 |
| --- | --- |
| 作为"皮肤层" | 独立于后端，用户可直接编辑 |
| 便于 Git 追踪 | 用户修改的翻译可追溯 |
| 支持 .obsidian/ 配置 | 允许用户自定义主题/插件 |

---

## 7. 下一步

1. 执行 `开发配置.md` 创建目录结构
2. 从 PodFlow 复用核心模块
3. 实现新增服务 (Segmentation, Translation, Obsidian)
4. 编写工作流编排 (runner.py, publisher.py)
5. 编写测试用例 (TDD 流程)

---

**文档结束** | 请审核后反馈修改意见

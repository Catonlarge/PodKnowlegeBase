# EnglishPod3 Enhanced 开发计划

| 文档版本 | V1.0 |
| --- | --- |
| **日期** | 2026-02-05 |
| **状态** | 待执行 |
| **开发模式** | TDD (Test-Driven Development) |
| **预计周期** | 6-8 周 |

---

## 目录

1. [项目概述](#1-项目概述)
2. [技术栈](#2-技术栈)
3. [开发原则](#3-开发原则)
4. [开发阶段规划](#4-开发阶段规划)
5. [里程碑与交付物](#5-里程碑与交付物)
6. [风险管理](#6-风险管理)

---

## 1. 项目概述

### 1.1 项目目标

构建一个 Local-First、AI 驱动的英语学习内容自动化工作流系统，实现：

- **用户掌控感**：CLI 终端可视化进度，去轮询化显式触发
- **断点续传**：基于数据库状态的可靠恢复机制
- **内容资产化**：RLHF 双文本存储，构建训练数据集
- **多平台分发**：飞书、腾讯 IMA、营销端一键发布

### 1.2 核心架构

```
┌─────────────────────────────────────────────────────────────┐
│                      用户交互层                               │
├─────────────────────────────────────────────────────────────┤
│  CLI (run.py, publish.py)  │  Obsidian (Markdown 文档)      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (app/)                           │
├─────────────────────────────────────────────────────────────┤
│  api/ (HTTP)  │  services/ (业务逻辑)  │  models/ (数据)    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据层                                  │
├─────────────────────────────────────────────────────────────┤
│  SQLite Database  │  Obsidian Vault  │  Audio Files         │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 工作流状态机

```
0: INIT              → 已入库，URL已记录
1: DOWNLOADED        → 本地文件就绪
2: TRANSCRIBED       → WhisperX转录完成
3: SEGMENTED         → 语义章节切分完成
4: TRANSLATED        → 逐句翻译完成
5: READY_FOR_REVIEW  → Obsidian文档已生成
6: PUBLISHED         → 已分发
```

---

## 2. 技术栈

### 2.1 后端技术栈

| 分类 | 技术 | 用途 |
| --- | --- | --- |
| **语言** | Python 3.8+ | 主要开发语言 |
| **Web框架** | FastAPI | HTTP API 接口 |
| **数据库** | SQLite + SQLAlchemy 2.0+ | 数据持久化 |
| **音频处理** | yt-dlp, FFmpeg | 音频下载与处理 |
| **语音识别** | WhisperX | 英文转录 |
| **AI服务** | OpenAI API / DeepSeek | 语义分析、翻译 |
| **终端UI** | Rich | 进度展示 |
| **测试** | pytest + pytest-cov | 单元测试与覆盖率 |

### 2.2 开发工具

| 工具 | 用途 |
| --- | --- |
| Git | 版本控制 |
| VSCode + Python Extension | 开发环境 |
| virtualenv | 虚拟环境隔离 |

---

## 3. 开发原则

### 3.1 TDD 工作流

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│   Red   │ ──→ │  Green  │ ──→ │ Refactor│
│ (写测试)│     │(写实现) │     │ (重构)  │
└─────────┘     └─────────┘     └─────────┘
```

**强制规则**：
1. 先写测试用例，再写实现代码
2. 测试覆盖率目标：80%+
3. 禁止在测试函数中使用 if/for/while，拆分为独立测试

### 3.2 代码质量标准

| 标准 | 要求 |
| --- | --- |
| **命名规范** | Python: snake_case (变量/函数), PascalCase (类) |
| **文档** | 所有类和函数必须有 Docstring |
| **类型提示** | 使用 Python Type Hints |
| **Git规范** | 遵循 Conventional Commits |
| **安全性** | API Key 通过 .env 管理，无硬编码 |

### 3.3 PodFlow 复用策略

| 模块 | 复用方式 | 来源 |
| --- | --- | --- |
| config.py | 完全复用 | PodFlow |
| file_utils.py | 完全复用 | PodFlow |
| hardware_patch.py | 完全复用 | PodFlow |
| whisper_service.py | 完全复用 | PodFlow |
| transcription_service.py | 适配复用 (90%) | PodFlow |
| ai_service.py | 完全复用 | PodFlow |

---

## 4. 开发阶段规划

---

### Phase 0: 项目初始化 (Week 1, Day 1-2)

**目标**：搭建项目基础架构，配置开发环境

#### 4.0.1 任务清单

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 创建项目目录结构 | P0 | 1h |
| 初始化 Git 仓库 | P0 | 0.5h |
| 配置 .env.example | P0 | 0.5h |
| 编写 requirements.txt | P0 | 1h |
| 创建虚拟环境并安装依赖 | P0 | 0.5h |
| 编写项目 README.md | P1 | 1h |

#### 4.0.2 交付物

- [ ] 完整的目录结构（符合项目目录设计.md）
- [ ] requirements.txt
- [ ] .env.example
- [ ] .gitignore
- [ ] README.md

#### 4.0.3 验收标准

- [ ] 运行 `python -m pytest` 无报错
- [ ] 虚拟环境可正常激活
- [ ] .env 文件不提交到 Git

---

### Phase 1: 数据库与模型层 (Week 1, Day 3-5)

**目标**：建立数据库表结构，实现 ORM 模型

#### 4.1.1 任务清单

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 创建 database.py (连接管理) | P0 | 1h |
| 实现 Episode 模型 | P0 | 1h |
| 实现 AudioSegment 模型 | P0 | 1h |
| 实现 TranscriptCue 模型 | P0 | 1h |
| 实现 Translation 模型 | P0 | 1h |
| 实现 Chapter 模型 | P0 | 1h |
| 实现 MarketingPost 模型 | P0 | 1h |
| 实现 PublicationRecord 模型 | P0 | 1h |
| 实现 TranslationCorrection 模型 | P0 | 0.5h |
| 编写 init_db.py 脚本 | P0 | 1h |

#### 4.1.2 测试用例 (TDD)

```python
# tests/unit/models/test_episode.py
def test_episode_create():
    """测试创建 Episode 记录"""
    # Given: 数据库会话和测试数据
    # When: 创建 Episode
    # Then: 验证字段正确

def test_episode_workflow_status_enum():
    """测试工作流状态枚举值"""
    # Given: 初始状态
    # When: 依次更新状态
    # Then: 验证状态转移正确

def test_episode_file_hash_unique():
    """测试 file_hash 唯一性约束"""
    # Given: 已有 file_hash
    # When: 插入相同 file_hash
    # Then: 抛出 IntegrityError

# tests/unit/models/test_translation.py
def test_translation_rlhf_dual_text():
    """测试 RLHF 双文本设计"""
    # Given: 创建 Translation
    # When: 更新 translation 字段
    # Then: is_edited 自动变为 True

def test_translation_status_lifecycle():
    """测试翻译状态生命周期"""
    # Given: pending 状态
    # When: 依次转移状态
    # Then: 验证状态机正确

# tests/unit/models/test_marketing_post.py
def test_marketing_post_content_racing():
    """测试内容赛马设计（无唯一约束）"""
    # Given: 相同 episode_id 和 angle_tag
    # When: 插入多条记录
    # Then: 全部成功，无约束冲突
```

#### 4.1.3 交付物

- [ ] `app/models/` 下所有模型文件
- [ ] `app/database.py`
- [ ] `scripts/init_db.py`
- [ ] 单元测试覆盖率 > 90%

#### 4.1.4 验收标准

- [ ] 运行 `python scripts/init_db.py` 成功创建数据库
- [ ] 所有模型单元测试通过
- [ ] 外键级联删除正确工作
- [ ] 唯一性约束生效

---

### Phase 2: 核心服务层 - PodFlow 复用 (Week 2, Day 1-3)

**目标**：从 PodFlow 复用核心服务，适配新架构

#### 4.2.1 任务清单

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 复用 config.py | P0 | 0.5h |
| 复用 file_utils.py | P0 | 0.5h |
| 复用 hardware_patch.py | P0 | 0.5h |
| 复用 whisper_service.py | P0 | 1h |
| 适配 transcription_service.py | P0 | 2h |
| 复用 ai_service.py | P0 | 0.5h |

#### 4.2.2 测试用例 (TDD)

```python
# tests/unit/services/test_file_utils.py
def test_calculate_md5_async():
    """测试异步 MD5 计算"""
    # Given: 测试音频文件
    # When: 调用 calculate_md5_async
    # Then: 返回正确的 MD5 哈希

def test_get_audio_duration():
    """测试获取音频时长"""
    # Given: 测试音频文件
    # When: 调用 get_audio_duration
    # Then: 返回正确的秒数

# tests/unit/services/test_whisper_service.py
def test_transcribe_segment_success():
    """测试 Whisper 转录成功场景"""
    # Given: 音频分段文件
    # When: 调用 transcribe_segment
    # Then: 返回 TranscriptCue 列表

def test_transcribe_segment_hardware_acceleration():
    """测试硬件加速补丁生效"""
    # Given: CUDA 可用环境
    # When: 调用 transcribe_segment
    # Then: 使用 GPU 加速

# tests/unit/services/test_transcription_service.py
def test_segment_and_transcribe():
    """测试完整转录流程"""
    # Given: Episode 和音频文件
    # When: 调用 segment_and_transcribe
    # Then: 创建 AudioSegment 和 TranscriptCue

def test_transcription_resume_from_checkpoint():
    """测试断点续传"""
    # Given: 部分分段已转录
    # When: 重新调用 segment_and_transcribe
    # Then: 跳过已完成分段
```

#### 4.2.3 交付物

- [ ] `app/utils/file_utils.py`
- [ ] `app/utils/hardware_patch.py`
- [ ] `app/services/whisper/whisper_service.py`
- [ ] `app/services/transcription_service.py`
- [ ] `app/services/ai/ai_service.py`
- [ ] 单元测试覆盖率 > 85%

#### 4.2.4 验收标准

- [ ] Whisper 转录功能正常
- [ ] 断点续传机制生效
- [ ] 硬件加速补丁可用
- [ ] AI 服务接口统一

---

### Phase 3: 新增服务层 (Week 2, Day 4-5 + Week 3)

**目标**：实现新增的核心业务服务

#### 4.3.1 DownloadService - 音频下载服务

**任务清单**

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 DownloadService 类 | P0 | 2h |
| 实现 download() 方法 | P0 | 2h |
| 实现 download_with_metadata() 方法 | P0 | 1h |
| 实现 retry 逻辑（指数退避） | P0 | 1h |

**测试用例**

```python
# tests/unit/services/test_download_service.py
def test_download_youtube_audio():
    """测试下载 YouTube 音频"""
    # Given: YouTube URL
    # When: 调用 download
    # Then: 返回本地音频路径

def test_download_duplicate_detection():
    """测试重复下载检测"""
    # Given: 已下载的 URL (相同 MD5)
    # When: 再次调用 download
    # Then: 跳过下载，返回已有路径

def test_download_retry_on_failure():
    """测试下载失败重试"""
    # Given: 模拟网络失败
    # When: 调用 download
    # Then: 重试 3 次后抛出异常
```

---

#### 4.3.2 SegmentationService - 语义章节切分服务

**任务清单**

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 SegmentationService 类 | P0 | 2h |
| 实现 analyze_and_segment() 方法 | P0 | 3h |
| 设计 Prompt 模板 | P0 | 2h |
| 实现 JSON 解析与验证 | P0 | 1h |
| 实现 Chapter 关联 TranscriptCue | P0 | 1h |

**Prompt 设计**

```python
SEGMENTATION_PROMPT = """
你是一个专业的音频内容分析师。请分析以下英文转录文本，进行语义章节划分。

**输入：**
- 完整的英文 Transcript（含时间戳）
- 总时长：{duration} 分钟

**任务：**
1. 分析英文原文的语义转折点
2. 划分为 3-10 个章节
3. 直接输出**中文**的章节标题和摘要

**输出格式（JSON）：**
```json
{{
  "chapters": [
    {{
      "title": "开场介绍",
      "summary": "主持人介绍了今天的主题...",
      "start_time": 0.0,
      "end_time": 120.5
    }}
  ]
}}
```

**Transcript:**
{transcript}
"""
```

**测试用例**

```python
# tests/unit/services/test_segmentation_service.py
def test_analyze_and_segment():
    """测试语义章节切分"""
    # Given: TranscriptCue 列表
    # When: 调用 analyze_and_segment
    # Then: 返回 Chapter 列表

def test_segmentation_chinese_output():
    """测试输出为中文"""
    # Given: 英文 Transcript
    # When: 调用 analyze_and_segment
    # Then: Chapter.title 和 summary 为中文

def test_segmentation_time_coverage():
    """测试时间覆盖完整性"""
    # Given: TranscriptCue 列表（0-600秒）
    # When: 调用 analyze_and_segment
    # Then: Chapter 时间范围覆盖 0-600秒

def test_segmentation_cue_association():
    """测试 Cue 与 Chapter 关联"""
    # Given: Chapter 列表
    # When: 更新 TranscriptCue.chapter_id
    # Then: 每个 Cue 关联到正确的 Chapter
```

---

#### 4.3.3 TranslationService - 翻译服务

**任务清单**

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 TranslationService 类 | P0 | 2h |
| 实现 batch_translate() 方法 | P0 | 3h |
| 实现批次处理逻辑（每批50条） | P0 | 2h |
| 实现断点续传 | P0 | 2h |
| 实现 RLHF 双文本存储 | P0 | 1h |

**测试用例**

```python
# tests/unit/services/test_translation_service.py
def test_batch_translate():
    """测试批量翻译"""
    # Given: TranscriptCue 列表
    # When: 调用 batch_translate
    # Then: 创建 Translation 记录

def test_translation_dual_text_storage():
    """测试双文本存储"""
    # Given: 翻译完成
    # When: 查询 Translation
    # Then: original_translation 和 translation 相同

def test_translation_resume_from_pending():
    """测试翻译断点续传"""
    # Given: 部分 Cue 已翻译
    # When: 再次调用 batch_translate
    # Then: 跳过已完成 Cue

def test_translation_error_retry():
    """测试翻译失败重试"""
    # Given: 模拟 API 失败
    # When: 调用 batch_translate
    # Then: 记录错误，支持重试

def test_translation_multiple_languages():
    """测试多语言支持"""
    # Given: language_code='ja'
    # When: 调用 batch_translate
    # Then: 创建日语 Translation
```

---

#### 4.3.4 ObsidianService - Obsidian 文档生成服务

**任务清单**

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 ObsidianService 类 | P0 | 2h |
| 实现 render_episode() 方法 | P0 | 3h |
| 实现 cue://ID 锚点生成 | P0 | 2h |
| 实现 parse_episode() 方法 | P0 | 3h |
| 实现 Markdown 表格解析 | P0 | 2h |
| 实现 diff 检测与回填 | P0 | 2h |

**锚点生成**

```python
# app/models/transcript_cue.py
@property
def obsidian_anchor(self) -> str:
    """生成 Obsidian 隐形锚点"""
    time_str = f"{int(self.start_time // 60):02d}:{int(self.start_time % 60):02d}"
    return f"[{time_str}](cue://{self.id})"
```

**Markdown 模板**

```markdown
---
task_id: {episode.id}
url: {episode.source_url}
status: pending_review
---

# {episode.title}
> **全文概览：** {episode.ai_summary}

## 📑 章节导航
| 章节 | 时间 | 核心要点 |
| :--- | :--- | :--- |
{chapters_table}

{chapters_content}
```

**测试用例**

```python
# tests/unit/services/test_obsidian_service.py
def test_render_episode():
    """测试生成 Obsidian 文档"""
    # Given: Episode 和关联数据
    # When: 调用 render_episode
    # Then: 返回 Markdown 内容

def test_obsidian_anchor_generation():
    """测试锚点生成"""
    # Given: TranscriptCue (id=1024, start_time=65)
    # When: 调用 obsidian_anchor
    # Then: 返回 "[01:05](cue://1024)"

def test_parse_episode():
    """测试解析 Obsidian 文档"""
    # Given: Markdown 文件
    # When: 调用 parse_episode
    # Then: 返回 diff 列表

def test_parse_backfill_translation():
    """测试回填翻译修改"""
    # Given: 修改后的 Markdown
    # When: 调用 parse_episode
    # Then: 检测到 translation 差异

def test_markdown_table_parsing():
    """测试 Markdown 表格解析"""
    # Given: 包含 cue://ID 的表格
    # When: 解析表格
    # Then: 正确提取 Cue 和翻译
```

---

#### 4.3.5 MarketingService - 营销文案生成服务

**任务清单**

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 MarketingService 类 | P1 | 1h |
| 实现 generate_posts() 方法 | P1 | 3h |
| 设计多角度 Prompt 模板 | P1 | 2h |
| 实现内容赛马存储 | P1 | 1h |

**Prompt 模板**

```python
MARKETING_PROMPT_TEMPLATES = {
    "职场焦虑向": """
    基于以下内容，生成一篇"职场焦虑向"的小红书文案。
    要求：
    1. 标题制造焦虑感
    2. 正文突出痛点
    3. 提供解决方案

    内容：{content}
    """,

    "干货硬核向": """
    基于以下内容，生成一篇"干货硬核向"的小红书文案。
    要求：
    1. 标题突出实用性
    2. 正文知识密集
    3. 结构清晰

    内容：{content}
    """,
}
```

**测试用例**

```python
# tests/unit/services/test_marketing_service.py
def test_generate_posts():
    """测试生成营销文案"""
    # Given: Episode
    # When: 调用 generate_posts
    # Then: 返回 MarketingPost 列表

def test_content_racing_multiple_angles():
    """测试内容赛马（多角度）"""
    # Given: Episode
    # When: 调用 generate_posts
    # Then: 生成多种 angle_tag 的文案

def test_generate_chapter_level_posts():
    """测试章节级别文案生成"""
    # Given: Chapter
    # When: 调用 generate_posts
    # Then: 生成 chapter_id 不为空的文案
```

---

#### 4.3.6 Phase 3 交付物

- [ ] `app/services/download_service.py`
- [ ] `app/services/segmentation_service.py`
- [ ] `app/services/translation_service.py`
- [ ] `app/services/obsidian_service.py`
- [ ] `app/services/marketing_service.py`
- [ ] 单元测试覆盖率 > 85%

#### 4.3.7 Phase 3 验收标准

- [ ] 所有服务单元测试通过
- [ ] 断点续传机制生效
- [ ] RLHF 双文本正确存储
- [ ] Obsidian 锚点正确生成和解析

---

### Phase 4: 工作流编排与 CLI (Week 4)

**目标**：实现主工作流和发布工作流

#### 4.4.1 状态机实现

**任务清单**

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 WorkflowStatus 枚举 | P0 | 0.5h |
| 实现 state_machine.py | P0 | 2h |
| 实现 get_next_step() 方法 | P0 | 1h |
| 实现断点检测逻辑 | P0 | 1h |

**测试用例**

```python
# tests/unit/workflows/test_state_machine.py
def test_workflow_status_transitions():
    """测试工作流状态转移"""
    # Given: 初始状态 INIT
    # When: 依次调用 get_next_step
    # Then: 返回正确的处理函数

def test_resume_from_checkpoint():
    """测试断点续传"""
    # Given: workflow_status=TRANSCRIBED
    # When: 调用 get_next_step
    # Then: 返回 segment_episode 函数

def test_terminal_progress_warning():
    """测试终端断点提示"""
    # Given: 已有中间状态
    # When: 启动 run.py
    # Then: 显示"检测到历史任务"警告
```

---

#### 4.4.2 主工作流 (run.py)

**任务清单**

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 runner.py | P0 | 3h |
| 实现各阶段处理函数 | P0 | 4h |
| 实现 Rich 进度条展示 | P0 | 2h |
| 实现 scripts/run.py 入口 | P0 | 1h |

**进度面板设计**

```python
from rich.console import Console
from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TimeRemainingColumn

console = Console()

def display_progress_panel(episode_id, current_step, total_steps, step_name):
    """显示进度面板"""
    console.print(f"[bold blue]任务 ID:[/bold blue] {episode_id}")
    console.print(f"[bold green]当前阶段:[/bold green] Step {current_step}/{total_steps}: {step_name}")
    console.print(f"[cyan]进度:[/cyan] [{'#' * current_step}{'.' * (total_steps - current_steps)}] {current_step/total_steps*100:.0f}%")
```

**测试用例**

```python
# tests/integration/test_workflow_end_to_end.py
def test_run_workflow_end_to_end():
    """测试完整工作流"""
    # Given: YouTube URL
    # When: 调用 run_workflow
    # Then: Episode.workflow_status = READY_FOR_REVIEW

def test_run_workflow_resume():
    """测试工作流断点续传"""
    # Given: workflow_status=TRANSCRIBED 的 Episode
    # When: 调用 run_workflow
    # Then: 从 SEGMENTED 阶段继续

def test_run_workflow_duplicate_url():
    """测试重复 URL 处理"""
    # Given: 已存在的 URL
    # When: 调用 run_workflow
    # Then: 跳过下载，使用已有数据
```

---

#### 4.4.3 发布工作流 (publish.py)

**任务清单**

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 publisher.py | P0 | 3h |
| 实现 parse_and_backfill() | P0 | 2h |
| 实现 generate_marketing() | P0 | 1h |
| 实现 distribute_to_platforms() | P0 | 2h |
| 实现 scripts/publish.py 入口 | P0 | 1h |

**测试用例**

```python
# tests/integration/test_publish_workflow.py
def test_publish_workflow():
    """测试完整发布流程"""
    # Given: workflow_status=READY_FOR_REVIEW 的 Episode
    # When: 调用 publish_workflow
    # Then: workflow_status=PUBLISHED

def test_parse_obsidian_edits():
    """测试解析 Obsidian 修改"""
    # Given: 修改后的 Markdown
    # When: 调用 parse_and_backfill
    # Then: Translation.is_edited=TRUE

def test_publish_to_feishu():
    """测试发布到飞书"""
    # Given: Episode 和营销文案
    # When: 调用 distribute_to_platforms
    # Then: PublicationRecord 记录飞书发布状态
```

---

#### 4.4.4 Phase 4 交付物

- [ ] `app/workflows/state_machine.py`
- [ ] `app/workflows/runner.py`
- [ ] `app/workflows/publisher.py`
- [ ] `scripts/run.py`
- [ ] `scripts/publish.py`
- [ ] 集成测试覆盖率 > 75%

#### 4.4.5 Phase 4 验收标准

- [ ] 运行 `python scripts/run.py <URL>` 完成主工作流
- [ ] 运行 `python scripts/publish.py --id <ID>` 完成发布
- [ ] 断点续传正常工作
- [ ] Rich 终端进度条正确显示

---

### Phase 5: 发布平台适配器 (Week 5)

**目标**：实现多平台分发功能

#### 4.5.1 任务清单

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 BasePublisher 抽象类 | P0 | 1h |
| 实现 FeishuPublisher | P0 | 3h |
| 实现 ImaPublisher | P0 | 3h |
| 实现 MarketingPublisher | P0 | 2h |
| 实现统一异常处理 | P0 | 1h |

#### 4.5.2 BasePublisher 设计

```python
# app/services/publishers/base.py
from abc import ABC, abstractmethod

class BasePublisher(ABC):
    """发布器基类"""

    @abstractmethod
    def publish(self, episode: Episode, content: dict) -> PublicationRecord:
        """
        发布内容到平台

        Args:
            episode: Episode 对象
            content: 发布内容字典

        Returns:
            PublicationRecord 记录
        """
        pass

    @abstractmethod
    def validate_config(self) -> bool:
        """验证平台配置"""
        pass
```

#### 4.5.3 测试用例

```python
# tests/unit/services/publishers/test_base_publisher.py
def test_base_publisher_is_abstract():
    """测试基类不可实例化"""
    # Given: BasePublisher
    # When: 尝试实例化
    # Then: 抛出 TypeError

# tests/unit/services/publishers/test_feishu_publisher.py
def test_feishu_publish_success():
    """测试飞书发布成功"""
    # Given: FeishuPublisher 和 Episode
    # When: 调用 publish
    # Then: 返回 PublicationRecord(status='success')

def test_feishu_publish_failure():
    """测试飞书发布失败"""
    # Given: 模拟 API 失败
    # When: 调用 publish
    # Then: PublicationRecord 包含 error_message

def test_publisher_isolation():
    """测试平台隔离（单个失败不影响其他）"""
    # Given: Feishu 失败，IMA 成功
    # When: 调用 distribute_to_platforms
    # Then: 两条 PublicationRecord 状态独立
```

#### 4.5.4 Phase 5 交付物

- [ ] `app/services/publishers/base.py`
- [ ] `app/services/publishers/feishu.py`
- [ ] `app/services/publishers/ima.py`
- [ ] `app/services/publishers/marketing.py`
- [ ] 单元测试覆盖率 > 80%

#### 4.5.5 Phase 5 验收标准

- [ ] 飞书发布功能正常
- [ ] IMA 发布功能正常
- [ ] 单个平台失败不影响其他平台
- [ ] PublicationRecord 正确记录发布状态

---

### Phase 6: API 层与文档 (Week 6)

**目标**：实现 HTTP API 接口

#### 4.6.1 任务清单

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 实现 FastAPI 主入口 | P1 | 1h |
| 实现 Episodes API | P1 | 2h |
| 实现 Transcripts API | P1 | 1h |
| 实现 Translations API | P1 | 1h |
| 实现 Chapters API | P1 | 1h |
| 实现 Marketing API | P1 | 1h |
| 实现 Publications API | P1 | 1h |
| 编写 API 文档 | P1 | 2h |

#### 4.6.2 API 端点设计

| 端点 | 方法 | 功能 |
| --- | --- | --- |
| `/episodes` | POST | 创建 Episode |
| `/episodes` | GET | 获取 Episode 列表 |
| `/episodes/{id}` | GET | 获取 Episode 详情 |
| `/episodes/{id}/transcripts` | GET | 获取字幕 |
| `/episodes/{id}/chapters` | GET | 获取章节 |
| `/episodes/{id}/marketing-posts` | GET | 获取营销文案 |
| `/translations/{id}` | PATCH | 修正翻译 |
| `/episodes/{id}/publish` | POST | 触发发布 |

#### 4.6.3 Phase 6 交付物

- [ ] `app/main.py`
- [ ] `app/api/` 下所有路由文件
- [ ] `app/schemas/` 下所有 Pydantic 模型
- [ ] API 文档 (Swagger UI)

#### 4.6.4 Phase 6 验收标准

- [ ] 所有 API 端点可访问
- [ ] Swagger 文档正确显示
- [ ] API 测试通过

---

### Phase 7: 测试与优化 (Week 7)

**目标**：完善测试覆盖，优化性能

#### 4.7.1 任务清单

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 补充单元测试 | P0 | 8h |
| 编写集成测试 | P0 | 4h |
| 性能测试（大文件） | P1 | 2h |
| 端到端测试 | P0 | 2h |
| 测试覆盖率报告 | P0 | 1h |

#### 4.7.2 测试覆盖率目标

| 模块 | 目标覆盖率 |
| --- | --- |
| models/ | 90%+ |
| services/ | 85%+ |
| workflows/ | 80%+ |
| api/ | 75%+ |
| **整体** | **80%+** |

#### 4.7.3 端到端测试场景

```python
# tests/e2e/test_complete_workflow.py
def test_complete_workflow_from_url_to_published():
    """测试完整工作流：从 URL 到发布"""
    # Given: YouTube URL
    # When:
    #   1. 调用 run.py
    #   2. 修改 Obsidian 文档
    #   3. 调用 publish.py
    # Then:
    #   1. workflow_status = PUBLISHED
    #   2. 所有平台发布成功
```

---

### Phase 8: 部署与文档 (Week 8)

**目标**：完善项目文档，准备交付

#### 4.8.1 任务清单

| 任务 | 优先级 | 预计工时 |
| --- | --- | --- |
| 编写开发配置文档 | P0 | 2h |
| 编写用户使用手册 | P0 | 3h |
| 编写部署文档 | P1 | 2h |
| 编写故障排查指南 | P1 | 1h |
| 代码审查与重构 | P0 | 4h |
| 更新 CHANGELOG.md | P0 | 1h |

#### 4.8.2 Phase 8 交付物

- [ ] `docs/开发配置.md`
- [ ] `docs/用户手册.md`
- [ ] `docs/部署文档.md`
- [ ] `docs/故障排查.md`
- [ ] `CHANGELOG.md`
- [ ] 代码审查报告

---

## 5. 里程碑与交付物

### 5.1 里程碑时间表

| 里程碑 | 时间 | 关键交付物 |
| --- | --- | --- |
| **M1: 项目启动** | Week 1 | 项目结构、数据库模型 |
| **M2: 核心服务** | Week 3 | 所有服务层实现 |
| **M3: 工作流完成** | Week 4 | run.py 和 publish.py 可用 |
| **M4: 平台集成** | Week 5 | 发布平台适配器完成 |
| **M5: API 就绪** | Week 6 | HTTP API 接口完成 |
| **M6: 测试完成** | Week 7 | 测试覆盖率达标 |
| **M7: 项目交付** | Week 8 | 文档齐全，可上线 |

### 5.2 交付物清单

#### 代码交付物

- [ ] `backend/` - 完整后端代码
- [ ] `obsidian/` - Obsidian Vault 模板
- [ ] `docs/` - 完整文档

#### 文档交付物

- [ ] README.md - 项目说明
- [ ] docs/prd.md - 产品需求文档
- [ ] docs/database-design.md - 数据库设计
- [ ] docs/项目目录设计.md - 目录结构设计
- [ ] docs/开发计划.md - 本文档
- [ ] docs/开发配置.md - 开发环境配置
- [ ] docs/用户手册.md - 用户使用手册
- [ ] docs/部署文档.md - 部署指南
- [ ] docs/故障排查.md - 故障排查
- [ ] CHANGELOG.md - 变更日志

---

## 6. 风险管理

### 6.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
| --- | --- | --- | --- |
| WhisperX 性能瓶颈 | 中 | 高 | 1. 虚拟分段机制 2. 硬件加速补丁 |
| LLM API 限流 | 高 | 中 | 1. 批次处理 2. 断点续传 3. 重试机制 |
| Obsidian 解析失败 | 低 | 中 | 1. 格式验证 2. 错误提示 |
| 数据库迁移问题 | 低 | 高 | 1. 完整测试 2. 备份脚本 |

### 6.2 进度风险

| 风险 | 概率 | 影响 | 缓解措施 |
| --- | --- | --- | --- |
| PodFlow 复用适配困难 | 中 | 中 | 提前评估复用模块，预留适配时间 |
| 测试覆盖不足 | 中 | 高 | 强制 TDD 流程，定期检查覆盖率 |
| 文档不完整 | 低 | 中 | 每个阶段同步更新文档 |

---

## 7. 附录

### 7.1 Git Commit 规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型**
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档变更
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建/工具链

**示例**
```
feat(services): 实现 SegmentationService

- 实现 analyze_and_segment() 方法
- 设计 Prompt 模板
- 实现 Chapter 关联 TranscriptCue

Closes #123
```

### 7.2 测试运行命令

```bash
# 激活虚拟环境
D:\programming_enviroment\learning-EnglishPod3\backend\venv\Scripts\Activate.ps1

# 运行所有测试
pytest

# 运行指定模块测试
pytest tests/unit/services/test_download_service.py

# 生成覆盖率报告
pytest --cov=app --cov-report=html

# 运行集成测试
pytest tests/integration/

# 运行端到端测试
pytest tests/e2e/
```

### 7.3 开发环境检查清单

- [ ] Python 3.8+ 已安装
- [ ] virtualenv 已创建
- [ ] .env 文件已配置
- [ ] FFmpeg 已安装
- [ ] CUDA 驱动已安装（GPU 加速）
- [ ] Git 已配置
- [ ] VSCode Python 扩展已安装

---

**文档结束** | 请审核后反馈修改意见
